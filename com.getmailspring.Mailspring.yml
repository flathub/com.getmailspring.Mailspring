app-id: com.getmailspring.Mailspring
runtime: org.freedesktop.Platform
runtime-version: '25.08'
base: org.electronjs.Electron2.BaseApp
base-version: '25.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.node24
command: start-mailspring
separate-locales: false
rename-icon: mailspring
rename-appdata-file: mailspring.appdata.xml
rename-desktop-file: Mailspring.desktop

finish-args:
  # Electron apps need this to work properly
  - --share=network
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  - --socket=pulseaudio
  - --device=dri

  # Saving of attachments
  - --filesystem=xdg-download
  - --filesystem=xdg-documents

  # Desktop integration
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.freedesktop.ScreenSaver
  - --filesystem=xdg-run/pipewire-0
  - --env=XCURSOR_PATH=/run/host/user-share/icons:/run/host/share/icons

  # Secret storage
  - --talk-name=org.freedesktop.secrets
  - --talk-name=org.kde.kwalletd5
  - --talk-name=org.kde.kwalletd6

  # Status notifier and app menu support
  - --talk-name=org.kde.StatusNotifierWatcher
  - --talk-name=com.canonical.AppMenu.Registrar

  # Battery awareness
  - --system-talk-name=org.freedesktop.UPower

modules:
  - name: libctemplate
    buildsystem: autotools
    sources:
      - type: archive
        url: https://github.com/OlafvdSpek/ctemplate/archive/refs/tags/ctemplate-2.4.tar.gz
        sha256: ccc4105b3dc51c82b0f194499979be22d5a14504f741115be155bd991ee93cfa

  - name: libtidy
    buildsystem: cmake
    sources:
      - type: archive
        url: https://github.com/htacg/tidy-html5/archive/refs/tags/5.8.0.tar.gz
        sha256: 59c86d5b2e452f63c5cdb29c866a12a4c55b1741d7025cf2f3ce0cde99b0660e
    config-opts:
      - -DCMAKE_POLICY_VERSION_MINIMUM=3.5

  - name: libcares
    buildsystem: cmake
    sources:
      - type: archive
        url: https://github.com/c-ares/c-ares/archive/refs/tags/v1.34.6.tar.gz
        sha256: 4358939ff800b13b92f37d5fdda003718101faedfbdee792d6b79ddc1a53d890

  - name: Mailspring
    buildsystem: simple
    sources:
      - type: git
        url: https://github.com/Foundry376/Mailspring.git
        tag: 1.18.0
      - type: patch
        paths:
          - patches/libetpan-mailstream_ssl.patch
          - patches/libmailcore2-cmake.patch
          - patches/libmailcore2-zip.patch
          - patches/mailsync-cmake.patch
          - patches/mailsync-build.patch
          - patches/mailspring-gruntfile.patch
      - type: file
        path: start-mailspring.sh
    build-options:
      build-args:
        - --share=network
      append-path: /usr/lib/sdk/node24/bin
      env:
        CMAKE_INSTALL_PREFIX: /app          # Install to /app instead of /usr
        CMAKE_POLICY_VERSION_MINIMUM: "3.5" # The oldest version supported by SDK 25.08
        MAKEFLAGS: "-j$(nproc)"
    build-commands:
      # Build mailsync
      - cd mailsync && ./build.sh

      # Build Mailspring
      - npm ci
      - npm run build

      # Update the templates
      - sed -i 's|<%= name %>|com.getmailspring.Mailspring|g'                           app/build/resources/linux/Mailspring.desktop.in app/build/resources/linux/mailspring.appdata.xml.in
      - sed -i 's|<%= productName %>|Mailspring|g'                                      app/build/resources/linux/Mailspring.desktop.in app/build/resources/linux/mailspring.appdata.xml.in
      - sed -i 's|<%= description %>|The best email app for people and teams at work|g' app/build/resources/linux/Mailspring.desktop.in app/build/resources/linux/mailspring.appdata.xml.in
      - sed -i 's|Exec=mailspring|Exec=start-mailspring|g'                              app/build/resources/linux/Mailspring.desktop.in

      # Package the app
      - cp -r app/dist/mailspring-linux-x64 /app/share/mailspring
      - install -Dm755 start-mailspring.sh /app/bin/start-mailspring
      - install -Dm644 app/build/resources/linux/Mailspring.desktop.in /app/share/applications/Mailspring.desktop
      - install -Dm644 app/build/resources/linux/mailspring.appdata.xml.in /app/share/appdata/mailspring.appdata.xml
      - for size in 16 32 64 128 256 512; do
          [[ -e "app/build/resources/linux/icons/${size}.png" ]] && install -Dm644 "app/build/resources/linux/icons/${size}.png" "/app/share/icons/hicolor/${size}x${size}/apps/mailspring.png";
        done
