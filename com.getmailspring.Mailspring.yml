app-id: com.getmailspring.Mailspring
runtime: org.freedesktop.Platform
runtime-version: '25.08'
base: org.electronjs.Electron2.BaseApp
base-version: '25.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.node24
command: mailspring
separate-locales: false
rename-icon: mailspring
rename-appdata-file: mailspring.appdata.xml
rename-desktop-file: Mailspring.desktop

finish-args:
  # Electron apps need this to work properly
  - --share=network
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  - --socket=pulseaudio
  - --device=dri

  # Saving of attachments
  - --filesystem=xdg-download
  - --filesystem=xdg-documents

  # Desktop integration
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.freedesktop.ScreenSaver
  - --env=XCURSOR_PATH=/run/host/user-share/icons:/run/host/share/icons

  # Secret storage
  - --talk-name=org.freedesktop.secrets
  - --talk-name=org.kde.kwalletd5
  - --talk-name=org.kde.kwalletd6

  # Status notifier and app menu support
  - --talk-name=org.kde.StatusNotifierWatcher
  - --talk-name=com.canonical.AppMenu.Registrar

  # Battery awareness
  - --system-talk-name=org.freedesktop.UPower

modules:
  - name: libctemplate
    buildsystem: autotools
    sources:
      - type: archive
        url: https://github.com/OlafvdSpek/ctemplate/archive/refs/tags/ctemplate-2.4.tar.gz
        sha256: ccc4105b3dc51c82b0f194499979be22d5a14504f741115be155bd991ee93cfa
    cleanup:
      - /bin # template-converter, make_tpl_varnames_h, diff_tpl_auto_escape
      - /lib/*_nothreads.*

  - name: libtidy
    buildsystem: cmake
    config-opts:
      - -DCMAKE_POLICY_VERSION_MINIMUM=3.5
    sources:
      - type: archive
        url: https://github.com/htacg/tidy-html5/archive/refs/tags/5.8.0.tar.gz
        sha256: 59c86d5b2e452f63c5cdb29c866a12a4c55b1741d7025cf2f3ce0cde99b0660e
    cleanup:
      - /bin # tidy

  - name: libcares
    buildsystem: cmake
    config-opts:
      - -DCARES_BUILD_TOOLS=Off
    sources:
      - type: archive
        url: https://github.com/c-ares/c-ares/archive/refs/tags/v1.34.6.tar.gz
        sha256: 4358939ff800b13b92f37d5fdda003718101faedfbdee792d6b79ddc1a53d890

  - name: Mailspring
    buildsystem: simple
    sources:
      - type: git
        url: https://github.com/Foundry376/Mailspring.git
        tag: 1.18.0
        commit: d519939069369f292f2645b71e7d6e65b9b570bc
      - type: patch
        paths:
          - patches/libetpan-mailstream_ssl.patch
          - patches/libmailcore2-cmake.patch
          - patches/libmailcore2-zip.patch
          - patches/mailsync-cmake.patch
          - patches/mailsync-build.patch
          - patches/mailsync-multiarch.patch
          - patches/mailspring-gruntfile.patch
          - patches/mailspring-postinstall.patch
      - type: file
        path: mailspring.sh
      - generated-sources.json
    build-options:
      prepend-path: /usr/lib/sdk/node24/bin
      env:
        CMAKE_INSTALL_PREFIX: /app          # Install to /app instead of /usr
        CMAKE_POLICY_VERSION_MINIMUM: "3.5" # The oldest version supported by SDK 25.08
        MAKEFLAGS: "-j$(nproc)"

        # https://github.com/flatpak/flatpak-builder-tools/tree/master/node
        XDG_CACHE_HOME: /run/build/Mailspring/flatpak-node/cache
        npm_config_cache: /run/build/Mailspring/flatpak-node/npm-cache
        npm_config_offline: "true"
        npm_package_config_node_gyp_nodedir: /run/build/Mailspring/flatpak-node/cache/node-gyp/39.2.7
    build-commands:
      # Build mailsync
      - cd mailsync && ./build.sh

      # Build Mailspring
      - npm ci
      - npm run build

      # Update the templates
      - sed -i 's|<%= name %>|mailspring|g'                                             app/build/resources/linux/Mailspring.desktop.in app/build/resources/linux/mailspring.appdata.xml.in
      - sed -i 's|<%= productName %>|Mailspring|g'                                      app/build/resources/linux/Mailspring.desktop.in app/build/resources/linux/mailspring.appdata.xml.in
      - sed -i 's|<%= description %>|The best email app for people and teams at work|g' app/build/resources/linux/Mailspring.desktop.in app/build/resources/linux/mailspring.appdata.xml.in

      # Package the app
      - cp -r app/dist/mailspring-linux-* /app/share/mailspring
      - install -Dm755 mailspring.sh /app/bin/mailspring
      - install -Dm644 app/build/resources/linux/Mailspring.desktop.in /app/share/applications/Mailspring.desktop
      - install -Dm644 app/build/resources/linux/mailspring.appdata.xml.in /app/share/appdata/mailspring.appdata.xml
      - for size in 16 32 64 128 256 512; do
          [[ -e "app/build/resources/linux/icons/${size}.png" ]] && install -Dm644 "app/build/resources/linux/icons/${size}.png" "/app/share/icons/hicolor/${size}x${size}/apps/mailspring.png";
        done

cleanup:
  - /include
  - /share/doc
  - /share/man
  - /lib/cmake
  - /lib/pkgconfig
  - /lib/*.a
  - /lib/*.la
